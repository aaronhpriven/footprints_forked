{% extends 'base.html' %}
{% load compress %}

{% block title %}Footprint{% endblock %}

{% block css %}
    <link href="{{STATIC_URL}}jquery-ui-1.11.2/jquery-ui.css" rel="stylesheet" />
    <link href="{{STATIC_URL}}bootstrap3-editable/css/bootstrap-editable.css" rel="stylesheet" />
{% endblock %}

{% block extrahead %}
    <link href="{{STATIC_URL}}/select2-3.5.2/select2.css" rel="stylesheet" />
{% endblock %}

{% block js %}
    <script src="{{STATIC_URL}}js/underscore-min.js"></script>
    <script src="{{STATIC_URL}}js/backbone-min.js"></script>
    <script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false"></script>
    <script src="{{STATIC_URL}}tinymce/tinymce.min.js"></script>
    <script src="{{STATIC_URL}}/select2-3.5.2/select2.js"></script>

    {% compress js %}
        <script src="{{STATIC_URL}}jquery-ui-1.11.2/jquery-ui.js"></script>
        <script src="{{STATIC_URL}}bootstrap3-editable/js/bootstrap-editable.js"></script>
        <script src="{{STATIC_URL}}bootstrap3-editable/js/actor-form.js"></script>
    {% endcompress %}

    <script type="text/javascript">
        jQuery(document).ready(function() {
            jQuery.fn.editable.defaults.mode = 'inline';
            jQuery.fn.editable.defaults.ajaxOptions = {
               headers: {'X-HTTP-Method-Override': 'PATCH'}
            };
            jQuery('.editable').editable({namedParams: true});
            jQuery('.editable-actor').editable();
            jQuery('.editable-language').editable({
                namedParams: true,
                source: [{% for language in languages %}
                    {value: '{{language.id}}', text: "{{language.name}}"}{% if not forloop.last %},{% endif %}
                    {% endfor %}],
                select2: {
                    multiple: true,
                    width: 200,
                    placeholder: 'Select language',
                    allowClear: true
                }
            });
            jQuery('.do-you-know').on('save', function(e, params) {
                var dataName = jQuery(e.currentTarget).data('name');
                var elts = jQuery('[data-name="' + dataName + '"]').not(e.currentTarget);
                jQuery(elts).each(function(index) {
                    if (jQuery(this).is('.editable, .editable-language')) {
                        jQuery(this).editable('setValue', params.newValue, true);
                    }
                    jQuery(this).parents('div.description-list').show();
                });
                jQuery(e.currentTarget).parents('li').fadeOut(function() {
                    jQuery(this).remove();
                });
            });
        });
    </script>
{% endblock %}

{% block content %}
    {% with footprint=object book=object.book_copy imprint=object.book_copy.imprint work=object.book_copy.imprint.work %}
    <div class="object-detail footprint">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-8">
                <div class="breadcrumb">FOOTPRINT</div>
                <h2>
                    <img class="pull-left" src="{{STATIC_URL}}img/footprint.png" />
                    <span class="pull-left object-title" data-name='display-title'>{{footprint.display_title}}</span>
                    <div class="clearfix"></div>
                </h2>
                {% for media in footprint.digital_object.all %}
                    <img src="{{media.file.url}}"></img>
                {% endfor %}
                {% if footprint.narrative %}
                    <blockquote class="blockquote">
                    {{footprint.narrative}}
                    </blockquote>
                {% endif %}
                <br />
                <div class="evidence-container">
                    <dl class="dl-horizontal">
                        <div class="description-list" {% if not footprint.associated_date %}style="display: none"{% endif %}>
                            <dt>Footprint Date</dt>
                            <dd class="border-bottom">
                                <a href="#" class="{% if editable %}editable{% else %}readonly{% endif %}" data-name="associated_date"
                                    data-type="text" data-pk="{{footprint.id}}"
                                    data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                    data-url="/api/footprint/{{footprint.id}}/"
                                    data-title="Edit Date of Evidence">{{footprint.associated_date}}</a>
                            </dd>
                        </div>
                        {% if footprint.place %}
                            <dt>Footprint Place</dt>
                            <dd class="border-bottom">
                                <!-- a href="#" class="{% if editable %}editable{% else %}readonly{% endif %}" data-name="place"
                                    data-type="location" data-pk="{{footprint.id}}"
                                    data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                    data-url="/api/footprint/{{footprint.id}}/" data-title="Edit Place of Evidence"></a-->
                                    {{footprint.place}}
                            </dd>
                        {% endif %}
            
                        {% if footprint.actor.count > 0 %}
                            {% for actor in footprint.actor.all %}
                                <dt>{{actor.role.name}}</dt>
                                <dd class="border-bottom">
                                    {{actor.display_name}} 
                                    <div class="pull-right">
                                        {% if editable %}
                                        <a href="#" class="remove-footprint-actor" data-footprint-pk="{{footprint.id}}" data-actor-pk="{{actor.id}}"
                                            data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" title="remove person">
                                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span></a>
                                        {% endif %}
                                        &nbsp;
                                        <a href="/person/{{actor.person.id}}/" title="see details" class="foreign-key"><span class="glyphicon glyphicon-link" aria-hidden="true"></span></a>
                                    </div>
                                </dd>
                            {% endfor %}
                        {% endif %}
                    </dl>
                    <br />
                    <dl class="dl-horizontal">
                        <dt>Evidence Type</dt>
                        <dd class="border-bottom">
                            <a href="#" class="{% if editable %}editable{% else %}readonly{% endif %}" data-name="medium"
                                data-type="text" data-pk="{{footprint.id}}"
                                data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                data-url="/api/footprint/{{footprint.id}}/" data-title="Edit Evidence Type">{{footprint.medium}}</a>
                        </dd>
                        <div class="description-list" {% if footprint.medium_description == '' %}style="display: none"{% endif %}>
                            <dt>Evidence Description</dt>
                            <dd class="border-bottom">
                                <a href="#" class="{% if editable %}editable{% else %}readonly{% endif %}" data-name="medium_description"
                                    data-type="text" data-pk="{{footprint.id}}"
                                    data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                    data-url="/api/footprint/{{footprint.id}}/" data-title="Edit Evidence Description">{{footprint.medium_description}}</a>
                            </dd>
                        </div>
                        <dt>Evidence Location</dt>
                        <dd class="border-bottom">
                            <a href="#" class="{% if editable %}editable{% else %}readonly{% endif %}" data-name="provenance"
                                data-type="text" data-pk="{{footprint.id}}"
                                data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                data-url="/api/footprint/{{footprint.id}}/"
                                data-title="Edit Provenance of Evidence">{{footprint.provenance}}</a>
                        </dd>
                        <div class="description-list" {% if footprint.language.count < 1 %}style="display: none"{% endif %}>
                            <dt>Evidence Language</dt>
                            <dd class="border-bottom">
                                <a href="#" class="{% if editable %}editable-language{% else %}readonly{% endif %}" data-name="language"
                                    data-type="select2" data-pk="{{footprint.id}}"
                                    data-value="[{% for language in footprint.language.all %}{{language.id}}{% if not forloop.last %},{% endif %}{% endfor %}]"
                                    data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}"
                                    data-url="/api/footprint/{{footprint.id}}/" data-title="Edit Language of Evidence">
                                    {% for language in footprint.language.all %}
                                        {{language.name}}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </a>
                            </dd>
                        </div>
                        
                        <div class="description-list" {% if not footprint.title %}style="display: none"{% endif %}>
                            <dt>Title in evidence</dt>
                            <dd class="border-bottom">
                                <a href="#" class="{% if editable %}editable{% else %}readonly{% endif %}" data-name="title"
                                    data-type="text" data-pk="{{footprint.id}}"
                                    data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                    data-url="/api/footprint/{{footprint.id}}/"
                                    data-title="Edit Evidence Title">{{footprint.title}}</a>
                            </dd>
                        </div>
                        <div class="description-list" {% if footprint.call_number == '' %}style="display: none"{% endif %}>
                            <dt>Evidence Call Number</dt>
                            <dd class="border-bottom">
                                <a href="#" class="{% if editable %}editable{% else %}readonly{% endif %}" data-name="call_number"
                                    data-type="text" data-pk="{{footprint.id}}"
                                    data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                    data-url="/api/footprint/{{footprint.id}}/" data-title="Edit Evidence Call Number">{{footprint.call_number}}</a>
                            </dd>
                        </div>
                        
                        <div class="description-list" {% if not footprint.notes %}style="display: none"{% endif %}>
                            <dt>Notes</dt>
                            <dd class="border-bottom">
                                <a href="#" class="{% if editable %}editable{% else %}readonly{% endif %}" data-name="notes" data-type="textarea" data-pk="{{footprint.id}}"
                                    data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                    data-url="/api/footprint/{{footprint.id}}/" data-title="Edit Notes">{{footprint.notes|safe}}</a>
                            </dd>
                        </div>
                    </dl>
                    {% if editable %}
                    <dl class="dl-horizontal">
                        <dt>Do you know...</dt>
                        <dd>    
                            <ul class="additional-questions">
                                <li><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                                    <a href="#" class="{% if editable %}editable-actor{% endif %} do-you-know" data-name="actor"
                                        data-type="actor" data-pk="{{footprint.id}}" data-value=""
                                        data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                        data-url="/footprint/actor/{{footprint.id}}/add/">other people related to this evidence, e.g. sellers, owners, curators?</a>
                                </li>

                                {% if not footprint.place %}
                                    <li>
                                        <span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                                        <a href="#">the place where the footprint occurred?</a>
                                        </span>
                                    </li>
                                {% endif %}
                                {% if footprint.medium_description == '' %}
                                    <li><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                                    <a href="#" class="{% if editable %}editable{% endif %} do-you-know" data-name="medium_description"
                                        data-type="text" data-pk="{{footprint.id}}"
                                        data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                        data-value=""
                                        data-url="/api/footprint/{{footprint.id}}/">details about the evidence type, e.g. a catalog title?</a>
                                    </li>
                                {% endif %}
                                {% if footprint.call_number == '' %}
                                    <li><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                                    <a href="#" class="{% if editable %}editable{% endif %} do-you-know" data-name="call_number"
                                        data-type="text" data-pk="{{footprint.id}}"
                                        data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                        data-value=""
                                        data-url="/api/footprint/{{footprint.id}}/">the call number of the evidence?</a>
                                    </li>
                                {% endif %}
                                {% if not footprint.associated_date %}
                                    <li><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                                    <a href="#" class="{% if editable %}editable{% endif %} do-you-know" data-name="associated_date"
                                        data-type="text" data-pk="{{footprint.id}}"
                                        data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                        data-value=""
                                        data-url="/api/footprint/{{footprint.id}}/">the date when the footprint occurred?</a>
                                    </li>
                                {% endif %}                            
                                {% if footprint.language.count < 1 %}
                                    <li><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                                        <a href="#" class="{% if editable %}editable-language{% endif %} do-you-know" data-name="language"
                                            data-type="select2" data-pk="{{footprint.id}}" data-value=""
                                            data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}" 
                                            data-url="/api/footprint/{{footprint.id}}/">in which language this evidence was recorded?</a>
                                    </li>
                                {% endif %}
                                {% if not footprint.notes %}
                                    <li><span class="glyphicon glyphicon-question-sign" aria-hidden="true"></span>
                                        <a href="#" class="editable do-you-know" data-name="notes"
                                           data-type="textarea" data-pk="{{footprint.id}}" data-value=""
                                           data-params="{csrfmiddlewaretoken:'{{csrf_token}}'}"
                                           data-url="/api/footprint/{{footprint.id}}/" data-title="Edit Notes">any additional notes, clarifications, deductions or oddities?</a>
                                    </li>
                                {% endif %}
                            </ul>
                        </dd>
                    </dl>
                    {% endif %}
                </div>
                
                {% if book.percent_complete > 0 or imprint.percent_complete > 0 %}
                    <dl class="dl-horizontal">
                        <h3>More about {{work.title}}</h3>
                        {% if work %}
                            {% for actor in work.actor.all %}
                                <dt>{{actor.role.name}}</dt><dd class="border-bottom"><a href="/person/{{actor.person.id}}/">{{actor}}</a></dd>
                            {% endfor %}
                            {% if work.notes %}
                                <dt>Notes</dt><dd class="border-bottom">{{work.notes}}</dd>
                            {% endif %}
                        {% endif %}
                                                    
                        {% if book.percent_complete > 0 %}

                        {% endif %}
    
                        {% if imprint.percent_complete > 0 %}
                            {% if imprint.title %}
                                <dt>Imprint Title</dt><dd class="border-bottom">{{imprint.title}}</dd>
                            {% endif %}
                            {% if imprint.language.count > 0 %}
                                <dt>Publication Language</dt>
                                <dd class="border-bottom">
                                    {% for language in imprint.language.all %}
                                        {{language.name}}
                                    {% endfor %}
                                </dd>
                            {% endif %}
                            {% if imprint.date_of_publication %}
                                <dt>Publication Date</dt><dd class="border-bottom">{{imprint.date_of_publication}}</dd>
                            {% endif %}
                            {% if imprint.place %}
                                <dt>Publication Place</dt><dd class="border-bottom"><a href="/place/{{imprint.place.id}}/">{{imprint.place}}</a></dd>
                            {% endif %}
                            {% if imprint.actor.count > 0 %}
                                {% for actor in imprint.actor.all %}
                                    {% if not actor.role.is_author %}
                                        <dt>{{actor.role.name}}</dt>
                                        <dd class="border-bottom"><a href="/person/{{actor.person.id}}/">{{actor}}</a></dd>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endif %}
                    </dl>
                {% endif %}
            </div>
            <div class="col-md-4">
                <div class="sidebar-box">
                    {% with complete=footprint.percent_complete %}
                        <h4>Record Progress</h4>
                        <div>
                            <div class="progress pull-left">
                                <div class="progress-bar" role="progressbar"
                                    aria-valuenow="{{complete}}" aria-valuemin="0"
                                    aria-valuemax="100" style="width: {{complete}}%;">
                                </div>
                            </div>
                            <div class="progress-report pull-right">{{complete}}% complete</div>
                        </div>
                        <div class="clearfix"></div>
                        {% if editable %}
                        <div>
                            <strong>Do you know something important?</strong>
                            <p>Praesent fringilla sit amet dolor at congue. Fusce pretium neque rutrum luctus dictum.</p>
                            <button class="btn btn-sm btn-primary pull-right">Save</button>&nbsp;
                            <button class="btn btn-sm btn-default pull-right" style="margin-right: 6px;">Skip</button>
                        </div>
                        {% endif %}
                    {% endwith %}
                    <div class="clearfix"></div>
                </div>

                {% if editable %}
                <div class="sidebar-box">
                    <h4>Can you connect this record?</h4>
                    <p>Further describe your footprint by connecting similar records.</p>
                    {% for record in records %}
                        {{record}}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endwith %} 
{% endblock %}
